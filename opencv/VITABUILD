pkgname=OpenCV
pkgver=4.6.0
pkgrel=1
url="https://github.com/opencv/opencv"
source=("https://github.com/opencv/opencv/archive/refs/tags/${pkgver}.tar.gz" "opencv-ifdefs.patch" "ade-memalign.patch")
sha256sums=('SKIP' 'SKIP' 'SKIP')
depends=('zlib libwebp libpng')

prepare() {
  cd opencv-${pkgver}
  patch -p1 < ../opencv-ifdefs.patch
}

build() {
  cd opencv-${pkgver}
  mkdir build && cd build

  cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=$VITASDK/share/vita.toolchain.cmake -DCMAKE_INSTALL_PREFIX=$prefix \
    -DOPENCV_ENABLE_NONFREE=ON -DBUILD_SHARED_LIBS=OFF -DWITH_ITT=OFF -DWITH_OPENCL=OFF \
    -DBUILD_TESTS=OFF -DBUILD_PERF_TESTS=OFF -DBUILD_opencv_ts=OFF -DBUILD_opencv_apps=OFF 

  patch build/3rdparty/ade/ade-*/sources/ade/source/alloc.cpp ../ade-memalign.patch

  make -j$(nproc)
}

package () {
  cd opencv/build
  make DESTDIR=$pkgdir install
}
